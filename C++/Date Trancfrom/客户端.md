## 客户端

### 1.客户端结构体

```c++
struct RequestInfo
{
	int cmd;	 		//标志位，{"1":"秘钥协商","2":秘钥检验,"3":"秘钥注销"}
	string clientID;	//客户端IP
	string serverID;	//服务器IP
	string sign;		//签名
	string data;		//秘钥
};
```

### 2.客户端初始化

```c++
ClientOP::ClientOP(string jsonFile)
{
	//解析json文件，读文件->Value
	ifstream ifs(jsonFile);
	Value root;
	Reader r;
	r.parse(ifs, root);
	//读取客户端和服务器端口ID
	m_info.clientId = root["ClientId"].asString();
	m_info.serverId = root["ServerId"].asString();
}
```

### 3.秘钥协商

```c++
bool ClientOP::seckeyAgree()
{
	//0.生成秘钥对，将公钥字符串读出
	Cryptographic rsa;
	//生成秘钥对
	rsa.generateRsakey(1024);
	//读公钥文件
	ifstream ifs("public.pem");
	stringstream str;
	str << ifs.rdbuf();
	//初始化系列化数据
	RequestInfo reqInfo;
	reqInfo.clientID = m_info.clientId;
	reqInfo.serverID = m_info.serverId;
	reqInfo.cmd = 1;	//秘钥协商
	reqInfo.data = str.str();	//非对称加密的秘钥
	reqInfo.sign = rsa.rsaSign(str.str());	//签名
	CodecFactory* factory = new RequestFactory(&reqInfo);
	Codec* c = factory->createCodec();  //工厂类对象，调用多态，父类指针指向子类对象
	//得到序列化后的数据，可以将其发送给客户端
	string encstr = c->encodeMsg();
	//释放资源
	delete factory;
	delete c;

    //客户端
    

	return false;
}
```

## 服务器

```c++
class ServerOP
{
public:
	enum KeyLen{Len16=16,Len24=24,Len32=32};
	ServerOP(string json);//1.
	~ServerOP();
	void startServer();	//2.启动服务器
	void seckeyAgree(RequestMsg* reqMsg); //秘钥协商
	static void* working(void* arg);
	string getRandKey(KeyLen len);
private:
	unsigned int m_port;
	string m_serverID;
	map<pthread_t, TcpSocket*> m_tcp;
	TcpServer* m_server = NULL;
};
```

### 1.读取配置文件

```c++
ServerOP::ServerOP(string json)
{
	//解析json文件，读文件->Value
	ifstream ifs(json);
	Value root;
	Reader r;
	r.parse(ifs, root);
	//读取客户端和服务器端口ID
	m_serverID = root["ServerId"].asString();
	m_port = root["Port"].asInt();
}
```



### 2.启动服务器

```c++
void ServerOP::startServer()
{
	m_server = new TcpServer;
    //TcpServer 调用setListen和acceptConn接口实现服务器的连接
	m_server->setListen(m_port);
	while (1)
	{
		cout << "等待客户端连接..." << endl;
		TcpSocket* tcp = m_server->acceptConn();
		if (tcp = NULL)
		{
			continue;
		}
		pthread_t pid;
		pthread_create(&pid, NULL, working, this);
		m_tcp.insert(make_pair(pid, tcp));
	}
}
```



## 配置远程Linux环境

> 1.链接器-输入-库依赖项  （不需要加库的前后缀）
>
> 2.C/C++ -语言-标准gnu++11